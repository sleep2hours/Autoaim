# Autoaim
## RM 2020 Autoaim framework and code backup
### README_before_2020.3.3.md will no longer be displayed.  

#### Recent changes:
> * 2020.3.3
>> * ArmorPlate debug又找到了若干问题：
>>> * LightMatch在对某些灯条做出处理时，框选的装甲板角度有问题，个人认为是颜色过滤以及二值化的影响
>>> * ArmorPlate 角度阈值条件15度比较合理，但是误匹配会很多，主要问题就是异常角度的灯条，以及（小块噪点的影响），可以加入噪点合并函数
>>> * Armordecision 没能对invalid的装甲板进行筛除,被过滤的装甲板被决策模型接受了
>>> * 决策感觉来回切，这个需要避免
>> * 增加了HPG的trackerBar用以便捷调整视频位置
>
> * 2020.3.4
>> * 异常角度的灯条是由小块的噪点引起的，与阈值并没有很大关系。如果把阈值调的高一点，的确能非常显著地减少误匹配（整个视频没有一帧），但是会导致远距离能力显著下降（7m以内）。
>> * 限制远距离能力的是装甲板宽高比，不能写成固定的，必须要根据灯条的长度自适应改变（距离太远，宽高比变化很显著），已经拟合了一个变化函数，在很远距离的情况下提高比值
>> * 加入了一个自适应调整二值化阈值的接口（但还没写）
> * 2020.3.5
>> * 自适应的二值化阈值加入，使用的是上一次最佳装甲板对应灯条的平均面积进行计算
>> * 重新确定了自适应装甲板宽高比函数的系数，但是此系数表现不佳，由于是由最大值进行的拟合，可能将有些大值平滑掉了
>> * 加入了另一个trackerBar用于调试二值化阈值
> * 2020.3.5
>> * 拟合了新的函数，筛选掉了更多的值，让函数图像尽可能包络所有异常装甲板宽高比，远距离效果不错
>> * 修改Armordecision时发现了个问题，决策的分数可能会溢出，并且分数好像不是一直是正的,没有归一值
>> * 对cv_output1视频进行测试,发现一帧的异常（实际由算法造成的），其他的误判都是旧车装甲板旁边蓝色的反光亮点造成灯条角度异常引起的，所以我想知道我们的车是不是也能这么设计，在装甲板旁边设置有微弱反光的结构，让对方灯条处理产生偏差？（这个不会让对方瞎掉，但是对方可能会出现错判（如果对方的灯条处理机制类似））
> * 2020.3.7 -GQR
>> * 修正决策参数，决策过程
>> * 修正大装甲版的位姿计算问题
> * 2020.3.9 -HQY
>> * 弹道模型修改，发现原来的错误了。把单向空气阻力和多向空气阻力模型搞混了，改了过来，并且删除了单向空气阻力的单独的函数，需要通过宏定义切换
>> * 把所有push_back改成了emplace_back, ++操作全部前置了（看着舒服，用着也舒服）
>> * ArmorPlate中，修正了远距离非灯条的匹配
>> * 修正了aimBallistics显示的delay一直为-1(不发弹)的问题，但是相关参数还是要上车调
> * 2020.3.10 -HQY
>> * ArmorPlate中filter的处理方式存在问题，已经修复
>> * LightMatch进行了调试，灯条反光问题无法处理，需要重构代码（大佬的新算法）
> * 2020.3.11 -HQY
>> * ArmorPlate 修改了一些觉得处理的不好的地方，并且加入了对装甲板面积的判断(过小则不加入)（ArmorPlate优化先到此）
>> * LightMatch 优化了一些（没必要那么做、没必要多算几次的）地方(LightMatch 优化先到此)
>> * AimDeps.cc修改为AimDeps.hpp
> * 2020.3.13 - 3.14 -HQY
>> * 增加了灯条的二次阈值化，作为一个过渡性的算法，增强了灯条检测准确度
>> * 增加了面积限制以及新的阈值线性方程
>> * 修改了部分编译warnings，但是没有全部修改（因为这个并不重要）
> * 2020.3.18 -HQY
>> * 将所有warnings修正了，并且尝试拆分h与cpp文件，但是出现了很大的重定义问题
> * 2020.3.19 -HQY
>> * 修改了取流模块中模式切换的方式以及外部调用的方式
>> * 修改了装甲板保存信息的方式（微小改动）  
> * 2020.3.20 -HQY
>> * 修改了高性能取流集成模块无法正常取流的问题，对应修改了主框架中运行的逻辑，摄像头可以正常使用
>> * 发现了一个很大的问题，低曝光时如果场边灯光效果过于混乱，则会出现灯条待选区过多的现象（可能还是要使用颜色过滤）
>> * ![没有颜色过滤导致的错误匹配](https://github.com/Enigmatisms/PicStorage/blob/master/Autoaim/false.png?raw=true)  
> * 2020.3.22 -HQY
>> * 删除了取流模块中一些不必要的函数，并且使用测试节点进行测试，修正了取流模块中无法正常切换自瞄模式的问题
>> * 框架主函数修改，变动了一些与取流模块相关的参数，删除了一些操作
>> * 发现了取流模块的一个问题，找到了解决办法，但是那个解决办法。。。比较玄学，需要对代码进行大量重构
> * 2020.3.24 -HQY
>> * 解决了取流问题，但是集成化的取流导致了取流速度少了3fps/s
>> * 问题很大！现在的算法跑一帧要15ms左右，才68fps，太慢了
> * 2020.3.25 -HQY
>> * 将要对取流模块进行亿点重构，想法是使用一个callBack来解决问题，因为我发现，把函数处理放在解码后面效果将会非常好，放在解码函数外部则函数处理时间收到限制（>7ms的处理将使画面失真）
>> * 明天考虑这个问题：把setBufferState再次移到外部看看，我还是希望不要传递函数指针
>> * 使用GrabOpenCV写了个回调，把处理函数在解码 hpg::HPGrabbing::readBuffer内回调执行，发现异常地流畅
>> * 如果setBufferState移出不行，则考虑使用回调(组织结构看起来很难受，但是效果好)
>> * 发现如果不显示画面，我们处理一帧的时间能控制在11.5ms以内（无数字识别）,还是能够接受的,11.5ms还是收到取流速度限制的正常速度
> * 2020.3.26 -HQY
>> * 没有重构取流，找到了一个移出解锁函数的方式，现在可以完全正常使用
>> * 近距离打击显示画面时有点问题，不显示时没有问题
> * 2020.3.28 -HQY
>> * 找到了aim_vic卡住的原因
>> * 重新配置了yaml文件，参数都可以在roslauch这一步输入
>> * 测试了一下时间，aim_vic还是老问题，在有图片显示的时候60ms一帧
> * 2020.3.30 -HQY BRANCH DEBUG
>> * LightMatch重新制定了一个二次阈值化的方法，原来误匹配的位置消除了，但出现了一些新的问题：
>>> * 阈值化的值过大，有一帧的灯条因此向一边倾斜
>>> * 面积过小时，阈值化的阈值过小，导致小面积灯条不准，造成新的误匹配，需要重新更改函数（第1810帧）
>>> * 长度补偿存在一点过补偿的问题，导致装甲板变形
>>> * 共灯条过滤需要更改，原来只是使用灯条角度差来过滤，现在需要加入面积匹配
>>> * 存在一个问题：第1120帧的灯条2角度计算有问题（只是计算）,应该是0度（从绘制的灯条矩形来看）而实际15度
>>> * 新的阈值化让10m内的灯条漏判减少了，但是11m以上则效果不佳（对极小面积进行重新拟合）
> * 2020.3.31 -HQY BRANCH MASTER
>> * 拟合了一个很棒的函数，能够保证10m内低漏判，并且误匹配1800帧中只有一帧（那一帧可以用装甲板过滤算法筛掉，需要改进），装甲板灯条反光问题解决（代价是侧面角度很大的装甲板匹配精度有所下降）
>> * 加入了颜色过滤，参数还要调整
>> * 删除了灯条补偿，可能把LightMatch中的灯条补偿移到ArmorPlate环节做
> * 2020.4.2 -HQY BRANCH MASTER
>> * 对颜色过滤进行了修改，能够过滤掉所有不合适的噪声区域
>> * 增加了远距离下对变短灯条的补偿，但是效果还不够好，还需要修改
> * 2020.4.3 -HQY BRANCH MASTER
>> * 重写了一下灯条补偿函数，可以进行补偿，但是大概在7m时会有很少量帧发生最大60cm的测距突变
>> * 对远距离的灯条长度不一致的情况进行了补偿
>> * 明天考完试将可能要重构灯条这个结构体,需要提前加入angle这个参数,可能影响到其他代码
>> * 发现颜色过滤后多了一帧误匹配，但是这个在实际中不可能发生（红蓝灯条交替闪烁，灯条被捕捉到是紫色的）
> * 2020.4.5 -HQY BRANCH MASTER
>> * （较大的改动）重构了灯条表示，放弃了旋转矩形，使用了线段表示，并且更改了参数计算位置,修改了所有与灯条相关的位置
>> * 修改了过滤函数，放弃了角度差值比较，计算匹配装甲板的两个内角与直角的差值，现在除了比赛中不可能发生的那一帧误匹配，测试视频已经没有误匹配
>> * 加入了灯条补偿II：侧向装甲板灯条会收到阈值影响而被截短，造成装甲板四边形变形，加入了修正，能提高侧向装甲板的测距精度
