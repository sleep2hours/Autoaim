# Autoaim
## RM 2020 Autoaim framework and code backup
### README_before_2020.3.3.md will no longer be displayed.  
### README_before_2020.4.7.md will no longer be displayed.
#### Recent changes:
> * 2020.4.7 BRANCH MASTER -HQY
>> * 说是尝试多线程解决threshold问题，但是threshold多线程最少也要4.5ms才能跑完（遍历的方式真的不可取）,遂删除
>> * 考虑到cv::threshold快很多(0.001ms)，采用了一种新的颜色过滤方式，时间降到1ms，图像不稳定问题解决
> * 2020.4.9 BRANCH MASTER -HQY
>> * 修正了一个角度异常bug,目前测试视频没有错误匹配，但是侧面灯条长度不够理想
> * 2020.4.10
>> * 修正了侧面长度不准的问题，默认更长的灯条的角度以及长度是准确的情况下，根据长灯条构造短灯条
>> * 发现了一些小问题，可能影响PNP测距精度：二次阈值化的阈值很高（为了分离噪点）,导致灯条角度不准
>> * 为了减小角度误差，考虑使用一次阈值化的矩形选框角度进行修正
> * 2020.4.13
>> * 优化算法已经写完并且实现，但是存在BUG，会让灯条的角度变得很奇怪，明天继续debug
#### 注意: 包含文件结构的修改
> * 2020.4.14
>> * 今日没有进行优化算法的debug，只推了一个公式
>> * 将文件结构完全的修改了，所有的 hpp 文件被拆分成 hpp(只含定义) 与 src中的cc文件
> * 2020.4.15
>> * 修改了灯条优化算法，把一阶牛顿法换成了二阶牛顿法，发现效果非常好，对所有的灯条都是进行角度微调，收敛性很好并且很快
> * 2020.4.17
>> * 修改了一堆bug，比如角度微调是反的，abs函数竟然是给int的（这是最玄学的。。。我这有三个不同类型的abs函数）, 灯条过滤bug
>> * 增加了二次阈值失败保护，假设没有找到灯条，使用一次阈值化灯条并进行角度优化
>> * 修改以后无疑是完善了代码，但是同时也发现了问题，鲁棒性有点差，另一个测试视频还是有错误匹配的，究其原因：
>>> * 二次阈值化我觉得已经差不多了，而另一个测试视频的灯条噪点更恶心，很亮，阈值要调的更高，牺牲更多的灯条精度去消除这个噪声
>>> * 虽然我发现噪声区域的绿色通道值低，但绿色通道在非噪声区外围也是很低，用这个过滤可能会让灯条匹配更不准。。。
> * 2020.4.18
>> * 初步解决鲁棒性问题，第二次阈值化内又使用一次阈值化（不是多了一层阈值化），获取灯条的方向信息
>>> * 使用极高的阈值获取中间接近白色的部分，得到一个旋转矩形包络，这个旋转矩形是灯条的一个近似方向
>>> * 我们使用的灯条角度优化中，不再使用所有的轮廓点进行优化，而使用包络内的点进行优化（包络外的点很可能是噪点）
>>> * 使用的这种方法很快将两个测试视频中的误匹配全部消除，并且速度仍然达标
>>> * 可能做的优化：使用这种方法的话二次阈值看起来意义不大了？我想尝试一下降低二次阈值化的阈值，以获得更加精准的灯条长度，因为灯条的角度优化效果可以了，无需通过高阈值获得精准角度
> * 2020.4.18
>> * 尝试了只使用灯条方向矩形 + 无二次阈值方法，以及做了一些把阈值调小一些的努力，效果皆是不佳，爷吐了
>> * 也许传统的阈值化方式到了极限？开始做有关亚像素检测的工作了，对阈值化以后的轮廓点进行位置调整，还没做完
>> * 阈值化好像写的比较死？（我们的车的反光噪点tql），虽然这几个测试视频都不出现错误匹配，漏灯条现象也解决了，但是怕写的太死不够鲁棒
> * 2020.4.20
>> * 亚像素边缘检测已经加入，亚像素边缘已经可以使用了，但是边缘检测的加入让角度矩形的提取出了点问题
>>> * 1500 帧，估计是方向矩形选定阈值过大，导致点的匹配不够准确
>>> * 1610 帧左右，还没实际测到底有什么问题，知道有问题就行了
>>> * 个人担心调小阈值会导致另一个视频阈值化结果不够理想（这就是不鲁棒所在？）
>> * 修正了几个bug,装甲板 过 过滤bug, 灯条相似度比较的cornerAngle bug
> * 2020.4.21
>> * 亚像素边缘检测已经加入并且可以正常使用，修改了几个函数的结构，精简了一下代码（但显然还是不够精简，运行时间多了1-2ms）
>> * 修正了有关过小矩形选框的问题以及亚像素边缘检测后方向矩形失去精度的问题
>> * 暂时性地修正了所有误匹配（假设以后还调参可能还有）
> * 2020.4.23
>> * 关于单个未匹配灯条过小的问题，个人认为这个解决起来比较的麻烦，因为是车的遮挡导致灯条变短，结合车上的反光漏光特征，这样的单灯条长度优化思路还要想一下（确定了一下问题）
>> * 修改了代码结构，原来执行这一趟操作时间比较长，开视频显示需要22ms，现在降为18ms（希望变得更快，尝试线程优化）
>> * 亚像素边缘检测改为了长方形选区（这个还可能要进行自适应修改）
>> * 暂时删除了一次阈值化矩形包络对长度的优化（使用了修改后的亚像素效果稍微好些）,灯条补偿需要重构（亚像素检测的效果比预期好）
>>> * 尝试一下矩形长宽比吧（这个不太稳，特别是灯条小的时候，但用了亚像素可能不一样？） 
> * 2020.4.24 凌晨(闲着没事干？)
>> * 想调整一下PNP解算的方式，但却发现了很大的问题
>>> * 在有一个专门测试远距离的视频中，7m以上表现奇差，主要问题是：
>>>> * 限制了选框的大小不能过小（但是选框很远的时候就是很小）（区分噪声不能就看大小）
>>>> * 亚像素边缘检测的窗口大小需要自适应，否则会爆炸（选区过小, 找点找到一块去了）
> * 2020.4.24
>> * 增加了方向矩形置信度过低弃用的操作，减少了一些由于病态的方向矩形提取而导致的角度不匹配
>> * 亚像素边缘检测的窗口大小自适应，并且与灯条角度存在关系
>> * 修改了灯条补偿中灯条重建的方式，对有些灯条表现非常不错，另一些则十分病态
>> * 修正了给雷达组提供的接口
>>> * 尝试判断补偿角大小
> * 2020.4.25
>> * 修改了颜色过滤，减弱了环境光导致的非正常灯条
>> * 灯条补偿算法重构, 结合了外矩形包络信息，修正了补偿的不鲁棒特性
>> * 调整了方向矩形的置信度阈值
>> * 测试了所有视频，发现了在一个视频中的问题：
>>> * 极远距离(10m+) 情况下，由于亚像素检测的不稳定性，导致了装甲板左右灯条的长度非常不稳
>>> * 有一帧(264)在能见度良好的状态下失配了，可能是亚像素的问题，也可能是灯条提取阈值的问题
>>> * 还剩下一个杂灯条问题：强烈的车体反光可能被当成灯条（被当成很远很小的灯条）,需要想办法在不影响远距离检测的情况下过滤
>>> * 失败的尝试：单灯条长度优化，这个太难了，优化信息不足，侧面灯条重合以及反光，车轮遮挡的问题让这个问题变得很复杂（给雷达组提供）
> * 2020.4.26
>> * 重构了远距离情况下的灯条补偿，不稳定性降低(但是问题仍然存在，就是因为远)
>> * 修改了灯条提取条件，减少了某些错误灯条（但是还有反光灯条和某些颜色过滤不完全的灯条）
>> * 亚像素边缘提取窗口的获取方式优化了，并且重新确定了更加好的一次阈值化阈值
> * 2020.4.27 今天又忘记打卡了
>> * 对补偿函数中存在的未return bug进行了修复
>> * 修正了车体反光产生的灯条被算入的情况（增加了一点复杂度，因为有些灯条具体是不是反光只能在经过了装甲板匹配后才能清楚）
>>> * 加入了灯条struct中的 bool valid, 当无法准确判断灯条是否为车体反光时，记为false, 如果在装甲板匹配过程中找到了此灯条所在的装甲板，设为true
>>> * 使用了一种高亮点个数的方式，要比均值法/极值法/长度宽度比法更鲁棒一些，也不会增加过多时间（一次阈值化(局部)+一次countNonZero）
>> * 还有灯条旁边的小反光点（在灯条闪烁时可能会出现，需要修正）,可能被匹配为灯条（明日解决）
> * 2020.4.28
>> * 灯条小反光点过滤
>> * 对某些实现进行了小的改动，消除了灯条漏匹配现象
>> * 可能对于灯条和装甲板的处理先告一段落了，接下来是要优化速度，尽可能缩短运行时间(并行优化)
> * 2020.4.30
>> * 并行优化，尝试了LightMatch中几处不同的可能优化位置，最后确定了一处，使用三线程，让8灯条时的速度从3ms减少到1.6ms, 4灯条时从1.5ms减少到0.9ms
>> * 假设灯条再多一点会让处理变得很慢吗？复杂度？明天再对这个进行优化，此后灯条特征提取优化完成
>> * 估计从后天开始对框架结构进行优化，加入打符
> * 2020.5.1
>> * 优化了代码结构/优化了参数声明
>> * 尝试优化了HPG，发现mutex没有实际帮助，反倒让某些处理更加复杂了
>> * 修改了所有文件的函数参数定义(可以改的)
> * 2020.5.5
>> * 实现了CA模型下的Kalman滤波，但是存在过量超调以及不稳定问题, 还需要魔法调参
> * 2020.5.6
>> * 修改成了两个并行的4×4 kalman滤波，扩展的CA模型？（考虑速度，加速度，急动度（加速度之差分））
>> * 加入了超调阻尼，感觉不稳定的现象没那么严重了，但是超调还是有点大（鼠标控制），特别是由静止态突然启动，或者突然反向
> * 2020.5.7
>> * 修改了一些参数，超调以及不稳定问题还是那么玄学地存在, 感觉这个的优化没什么思路，查查资料去

